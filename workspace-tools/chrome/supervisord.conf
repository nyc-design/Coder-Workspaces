[supervisord]
nodaemon=true
user=root
logfile=/dev/fd/1
loglevel=info

[program:xvfb]
command=/usr/bin/Xvfb :100 -screen 0 1280x800x24 -nolisten tcp
autostart=true
autorestart=true
priority=10
environment=DISPLAY=":100"

[program:fluxbox]
command=/usr/bin/fluxbox
autostart=true
autorestart=true
priority=20
environment=DISPLAY=":100"

# Chrome inside the virtual display, CDP bound to localhost
[program:chrome]
command=/usr/bin/google-chrome --no-first-run --no-default-browser-check --disable-gpu --user-data-dir=/opt/chrome-profile --remote-debugging-address=127.0.0.1 --remote-debugging-port=9222 --window-size=1280,800
autostart=true
autorestart=true
priority=30
environment=DISPLAY=":100"

# Xpra HTML server bound to localhost
[program:xpra]
command=/usr/bin/xpra start :100 --daemon=no --bind-tcp=127.0.0.1:8081 --html=on
autostart=true
autorestart=true
priority=40
environment=DISPLAY=":100"

# Caddy (HTTPS terminated by Cloud Run; Caddy just does local proxying)
[program:caddy]
command=/usr/bin/caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
autostart=true
autorestart=true
priority=50
environment=PORT="8080",XPRA_PORT="8081",CDP_PORT="9222",BASIC_AUTH_USER="${BASIC_AUTH_USER}",BASIC_AUTH_HASH="${BASIC_AUTH_HASH}"