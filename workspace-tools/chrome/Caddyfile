{
  # Allow env vars in Caddyfile
  # (Cloud Run sets PORT; we supply BASIC_AUTH_USER / BASIC_AUTH_HASH via env)
}

:{$PORT} {
  # Health for Cloud Run
  @health path /health
  respond @health "ok" 200

  # ---- Basic Auth (public service but protected)
  # Generate a bcrypt hash locally:  caddy hash-password --plaintext 'YourSecret'
  # Provide both as env vars BASIC_AUTH_USER and BASIC_AUTH_HASH
  @all path /*
  basicauth @all {
    {$BASIC_AUTH_USER} {$BASIC_AUTH_HASH}
  }

  # Xpra HTML UI (live desktop)
  reverse_proxy 127.0.0.1:{$XPRA_PORT}

  # CDP endpoints â†’ Chrome; keep Host: localhost for Chrome devtools
  @cdp path /json* /devtools* /ws*
  reverse_proxy @cdp 127.0.0.1:{$CDP_PORT} {
    header_up Host localhost
  }
}