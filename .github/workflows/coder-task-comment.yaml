name: Forward Coder Issue Comments

on:
  workflow_call:
    secrets:
      CODER_URL:
        required: true
      CODER_SESSION_TOKEN:
        required: true
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  forward-comment:
    if: >
      github.event.issue.pull_request == null &&
      (
        contains(github.event.issue.labels.*.name, 'coder-claude') ||
        contains(github.event.issue.labels.*.name, 'coder-codex') ||
        contains(github.event.issue.labels.*.name, 'coder-gemini')
      ) &&
      startsWith(github.event.comment.body, '/coder')
    runs-on: ubuntu-latest

    steps:
      - name: Extract agent type from labels
        id: agent
        env:
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
        run: |
          set -euo pipefail

          AGENT_LABEL=$(echo "$ISSUE_LABELS" | jq -r '.[] | .name | select(startswith("coder-"))' | head -n 1)

          if [ -z "$AGENT_LABEL" ]; then
            echo "No coder label found; exiting."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          AGENT_TYPE="${AGENT_LABEL#coder-}"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "type=$AGENT_TYPE" >> "$GITHUB_OUTPUT"
          echo "label=$AGENT_LABEL" >> "$GITHUB_OUTPUT"
          echo "Detected agent type: $AGENT_TYPE"

      - name: Setup Coder CLI
        if: steps.agent.outputs.found == 'true'
        uses: coder/setup-action@v1
        with:
          access_url: ${{ secrets.CODER_URL }}
          coder_session_token: ${{ secrets.CODER_SESSION_TOKEN }}

      - name: Setup GitHub CLI
        if: steps.agent.outputs.found == 'true'
        run: |
          type -p gh >/dev/null || {
            (type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)) \
            && sudo mkdir -p -m 755 /etc/apt/keyrings \
            && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
            && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt update \
            && sudo apt install gh -y
          }
          gh --version

      - name: Locate Coder task for this issue
        id: task
        if: steps.agent.outputs.found == 'true'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ github.token }}
          CODER_URL: ${{ secrets.CODER_URL }}
          REPO_NAME: ${{ github.event.repository.name }}
          AGENT_TYPE: ${{ steps.agent.outputs.type }}
        run: |
          set -euo pipefail

          TASK_NAME="${REPO_NAME}-${AGENT_TYPE}-Issue-${ISSUE_NUMBER}"
          TASK_DATA=$(coder task list --all --output json || echo "[]")

          MATCH=$(echo "$TASK_DATA" | jq -r --arg NAME "$TASK_NAME" '
            map(select(.name == $NAME and (.status == "pending" or .status == "initializing" or .status == "active")))
            | sort_by(.created_at // .UpdatedAt // .updated_at // 0)
            | last
          ')

          if [ -z "$MATCH" ] || [ "$MATCH" = "null" ]; then
            gh issue comment "$ISSUE_NUMBER" --body "I couldn't find an active Coder task named \`$TASK_NAME\`. Please re-apply the coder label to restart the agent, then resend your comment."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TASK_ID=$(echo "$MATCH" | jq -r '.id // .ID')
          OWNER_NAME=$(echo "$MATCH" | jq -r '.owner_name // .owner // ""')

          if [ -z "$OWNER_NAME" ] || [ "$OWNER_NAME" = "null" ]; then
            OWNER_NAME=$(gh api "repos/${GITHUB_REPOSITORY}/issues/${ISSUE_NUMBER}/comments" --paginate --jq '
              [.[] | select(.body | startswith("Task created:"))] | last | .body // ""
            ' | sed -n 's#.*tasks/\([^/]*\)/[^/ )]*.*#\1#p' | head -n 1 || true)
          fi

          if [ -n "$OWNER_NAME" ] && [ "$OWNER_NAME" != "null" ]; then
            TASK_URL="${CODER_URL%/}/tasks/${OWNER_NAME}/${TASK_ID}"
          else
            TASK_URL="${CODER_URL%/}/tasks/${TASK_ID}"
          fi

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "id=$TASK_ID" >> "$GITHUB_OUTPUT"
          echo "name=$TASK_NAME" >> "$GITHUB_OUTPUT"
          echo "owner=$OWNER_NAME" >> "$GITHUB_OUTPUT"
          echo "url=$TASK_URL" >> "$GITHUB_OUTPUT"

      - name: Forward comment to task
        if: steps.task.outputs.found == 'true'
        env:
          TASK_ID: ${{ steps.task.outputs.id }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          set -euo pipefail

          MESSAGE=$(python3 - <<'PY'
          import os
          body = os.environ["COMMENT_BODY"]
          body = body.lstrip()
          if body.lower().startswith("/coder"):
              payload = body[6:].lstrip(" :\t-")
          else:
              payload = body
          payload = payload.strip()
          if not payload:
              payload = "(no additional instructions provided)"
          print(payload)
          PY
          )

          coder task send "$TASK_ID" "GitHub comment from @${COMMENT_AUTHOR} on issue #${ISSUE_NUMBER}: ${MESSAGE}"

      - name: Confirm forwarding
        if: steps.task.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          COMMENT_AUTHOR: ${{ github.event.comment.user.login }}
          TASK_URL: ${{ steps.task.outputs.url }}
        run: |
          COMMENT=$(cat <<EOF
          Forwarded @${COMMENT_AUTHOR}'s update to the running Coder task.

          - Task: [View progress here](${TASK_URL})

          The agent will incorporate the new instructions shortly.
          EOF
          )
          gh issue comment "$ISSUE_NUMBER" --body "$COMMENT"
