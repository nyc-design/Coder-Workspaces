name: Coder Issue Automation

on:
  workflow_call:
    secrets:
      CODER_URL:
        required: true
      CODER_SESSION_TOKEN:
        required: true
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  dispatch-to-coder:
    if: |
      contains(github.event.label.name, 'coder-') &&
      (github.event.label.name == 'coder-claude' ||
       github.event.label.name == 'coder-codex' ||
       github.event.label.name == 'coder-gemini')
    runs-on: ubuntu-latest

    steps:
      - name: Determine preset
        id: preset
        run: |
          LABEL="${{ github.event.label.name }}"
          AGENT="${LABEL#coder-}"
          case "$AGENT" in
            claude) PRESET="Issue Automation - Claude" ;;
            codex) PRESET="Issue Automation - Codex" ;;
            gemini) PRESET="Issue Automation - Gemini" ;;
            *)
              echo "Unsupported agent label: $LABEL" >&2
              exit 1
              ;;
          esac
          echo "preset=$PRESET" >> "$GITHUB_OUTPUT"

      - name: Start Coder Task
        uses: coder/create-task-action@v0
        with:
          coder-url: ${{ secrets.CODER_URL }}
          coder-token: ${{ secrets.CODER_SESSION_TOKEN }}
          coder-organization: "default"
          coder-template-name: "coder-tasks"
          coder-template-preset: ${{ steps.preset.outputs.preset }}
          coder-task-name-prefix: "gh-task"
          coder-task-prompt: |
            GH_REPO=${{ github.repository }}
            GH_ISSUE_URL=${{ github.event.issue.html_url }}
            GH_ISSUE_NUMBER=${{ github.event.issue.number }}

            You are working autonomously on GitHub issue #${{ github.event.issue.number }}: "${{ github.event.issue.title }}".

            IMPORTANT INSTRUCTIONS:
            1. Use `gh issue view ${{ github.event.issue.number }}` to read the full issue details.
            2. Analyze the issue, determine the required changes, and document your plan.
            3. Create a new branch: `git checkout -b fix/issue-${{ github.event.issue.number }}`.
            4. Implement the necessary code changes, including any tests or docs updates.
            5. Commit with descriptive messages and push the branch: `git push -u origin fix/issue-${{ github.event.issue.number }}`.
            6. Create a pull request with the title `Fix: ${{ github.event.issue.title }} (fixes #${{ github.event.issue.number }})` and body `Fixes #${{ github.event.issue.number }}\n\n[Automated PR created by Coder AI Agent]`.
            7. Obtain the PR URL and comment on the issue: `gh issue comment ${{ github.event.issue.number }} --body "I've created a PR to address this issue: [PR_URL]"`.
            8. If blockers arise, document them in the PR description and wait for feedback.

            Work carefully and thoroughly. Start by reviewing the issue now.
          github-user-id: ${{ github.event.sender.id }}
          github-issue-url: ${{ github.event.issue.html_url }}
          github-token: ${{ github.token }}
          comment-on-issue: true
