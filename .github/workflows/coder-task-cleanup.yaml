name: Cleanup Coder Tasks

on:
  workflow_call:
    secrets:
      CODER_URL:
        required: true
      CODER_SESSION_TOKEN:
        required: true
  issues:
    types: [closed]

permissions:
  issues: write
  contents: read

jobs:
  delete-task:
    if: >
      github.event.issue.pull_request == null &&
      (
        contains(github.event.issue.labels.*.name, 'coder-claude') ||
        contains(github.event.issue.labels.*.name, 'coder-codex') ||
        contains(github.event.issue.labels.*.name, 'coder-gemini')
      )
    runs-on: ubuntu-latest

    steps:
      - name: Extract agent type from labels
        id: agent
        env:
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
        run: |
          set -euo pipefail

          AGENT_LABEL=$(echo "$ISSUE_LABELS" | jq -r '.[] | .name | select(startswith("coder-"))' | head -n 1)

          if [ -z "$AGENT_LABEL" ]; then
            echo "No coder label found; exiting."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          AGENT_TYPE="${AGENT_LABEL#coder-}"
          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "type=$AGENT_TYPE" >> "$GITHUB_OUTPUT"
          echo "label=$AGENT_LABEL" >> "$GITHUB_OUTPUT"
          echo "Detected agent type: $AGENT_TYPE"

      - name: Setup Coder CLI
        if: steps.agent.outputs.found == 'true'
        uses: coder/setup-action@v1
        with:
          access_url: ${{ secrets.CODER_URL }}
          coder_session_token: ${{ secrets.CODER_SESSION_TOKEN }}

      - name: Setup GitHub CLI
        if: steps.agent.outputs.found == 'true'
        run: |
          type -p gh >/dev/null || {
            (type -p wget >/dev/null || (sudo apt update && sudo apt-get install wget -y)) \
            && sudo mkdir -p -m 755 /etc/apt/keyrings \
            && wget -qO- https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo tee /etc/apt/keyrings/githubcli-archive-keyring.gpg > /dev/null \
            && sudo chmod go+r /etc/apt/keyrings/githubcli-archive-keyring.gpg \
            && echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
            && sudo apt update \
            && sudo apt install gh -y
          }
          gh --version

      - name: Delete Coder task for this issue
        id: cleanup
        if: steps.agent.outputs.found == 'true'
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          GH_TOKEN: ${{ github.token }}
          CODER_URL: ${{ secrets.CODER_URL }}
          REPO_NAME: ${{ github.event.repository.name }}
          AGENT_TYPE: ${{ steps.agent.outputs.type }}
        run: |
          set -euo pipefail

          TASK_NAME="${REPO_NAME}-${AGENT_TYPE}-Issue-${ISSUE_NUMBER}"
          TASK_DATA=$(coder task list --all --output json || echo "[]")

          MATCH=$(echo "$TASK_DATA" | jq -r --arg NAME "$TASK_NAME" '
            map(select(.name == $NAME))
            | sort_by(.created_at // .UpdatedAt // .updated_at // 0)
            | last
          ')

          if [ -z "$MATCH" ] || [ "$MATCH" = "null" ]; then
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          TASK_ID=$(echo "$MATCH" | jq -r '.id // .ID')
          OWNER_NAME=$(echo "$MATCH" | jq -r '.owner_name // .owner // ""')

          if [ -n "$OWNER_NAME" ] && [ "$OWNER_NAME" != "null" ]; then
            TASK_URL="${CODER_URL%/}/tasks/${OWNER_NAME}/${TASK_ID}"
          else
            TASK_URL="${CODER_URL%/}/tasks/${TASK_ID}"
          fi

          coder task delete "$TASK_ID" --yes

          echo "found=true" >> "$GITHUB_OUTPUT"
          echo "url=$TASK_URL" >> "$GITHUB_OUTPUT"

      - name: Confirm cleanup
        if: steps.cleanup.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          TASK_URL: ${{ steps.cleanup.outputs.url }}
        run: |
          gh issue comment "$ISSUE_NUMBER" --body "Issue closed. Cleaned up the corresponding Coder task: ${TASK_URL}"
