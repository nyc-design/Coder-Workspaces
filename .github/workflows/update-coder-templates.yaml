name: Update Coder Templates

on:
  push:
    branches:
      - main
    paths:
      - "workspace-templates/**"
      - "workspace-modules/**"
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      changed_templates: ${{ steps.detect.outputs.changed_templates }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed template folders
        id: detect
        run: |
          set -euo pipefail

          ALL_TEMPLATES="$(find workspace-templates -mindepth 1 -maxdepth 1 -type d -exec basename {} \; | sort)"

          # Get list of changed files in the last commit
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # For manual runs, update all templates
            CHANGED_DIRS="$(echo "$ALL_TEMPLATES" | jq -R -s -c 'split("\n")[:-1]')"
          else
            # Get changed files for the entire push range (supports merge commits and multi-commit pushes)
            BASE_SHA="${{ github.event.before }}"
            HEAD_SHA="${{ github.sha }}"

            if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
              CHANGED_FILES="$(git diff --name-only HEAD~1 HEAD)"
            else
              CHANGED_FILES="$(git diff --name-only "$BASE_SHA" "$HEAD_SHA")"
            fi

            TEMPLATE_CHANGES="$(
              echo "$CHANGED_FILES" \
              | awk -F'/' '/^workspace-templates\/[^/]+\// {print $2}' \
              | sort -u
            )"

            CHANGED_MODULES="$(
              echo "$CHANGED_FILES" \
              | awk -F'/' '/^workspace-modules\/[^/]+\// {print $2}' \
              | sort -u
            )"

            AFFECTED_BY_MODULES=""
            if [ -n "$CHANGED_MODULES" ]; then
              while IFS= read -r template; do
                [ -z "$template" ] && continue
                while IFS= read -r module; do
                  [ -z "$module" ] && continue
                  if grep -R -q "workspace-modules/${module}" "workspace-templates/${template}"; then
                    AFFECTED_BY_MODULES="${AFFECTED_BY_MODULES}${template}"$'\n'
                    break
                  fi
                done <<< "$CHANGED_MODULES"
              done <<< "$ALL_TEMPLATES"
            fi

            CHANGED_DIRS="$(
              printf "%s\n%s\n" "$TEMPLATE_CHANGES" "$AFFECTED_BY_MODULES" \
              | sed '/^$/d' \
              | sort -u \
              | jq -R -s -c 'split("\n")[:-1]'
            )"

            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "Template changes:"
            echo "$TEMPLATE_CHANGES"
            echo "Changed modules:"
            echo "$CHANGED_MODULES"
            echo "Templates affected by module changes:"
            echo "$AFFECTED_BY_MODULES"
          fi

          echo "changed_templates=$CHANGED_DIRS" >> $GITHUB_OUTPUT
          echo "Changed template directories: $CHANGED_DIRS"

  update-templates:
    needs: detect-changes
    if: needs.detect-changes.outputs.changed_templates != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        template: ${{ fromJson(needs.detect-changes.outputs.changed_templates) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest commit hash
        id: latest_commit
        run: echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Get commit title
        id: commit_title
        run: echo "title=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT

      - name: Check if template directory exists
        id: check_dir
        run: |
          if [ -d "workspace-templates/${{ matrix.template }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Template directory workspace-templates/${{ matrix.template }} exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Template directory workspace-templates/${{ matrix.template }} does not exist (might be deleted)"
          fi

      - name: Update Coder Template
        if: steps.check_dir.outputs.exists == 'true'
        uses: matifali/update-coder-template@v3
        with:
          id: ${{ matrix.template }}
          dir: workspace-templates/${{ matrix.template }}
          url: ${{ secrets.CODER_URL }}
          name: ${{ steps.latest_commit.outputs.hash }}
          message: ${{ steps.commit_title.outputs.title }}
          activate: true
          coder_session_token: ${{ secrets.CODER_SESSION_TOKEN }}
